from docx import Document
from docx.shared import Pt
from docx.enum.text import WD_PARAGRAPH_ALIGNMENT
from bs4 import BeautifulSoup

def add_clean_html_paragraphs(doc, html_text):
    soup = BeautifulSoup(html_text, "html.parser")
    for elem in soup.contents:
        if elem.name == "h3":
            para = doc.add_paragraph()
            run = para.add_run(elem.get_text())
            run.bold = True
            run.font.size = Pt(14)
        elif elem.name == "b":
            para = doc.add_paragraph()
            run = para.add_run(elem.get_text())
            run.bold = True
        elif elem.name == "em":
            para = doc.add_paragraph()
            run = para.add_run(elem.get_text())
            run.italic = True
        elif elem.name == "ul":
            for li in elem.find_all("li"):
                doc.add_paragraph(li.get_text(), style='List Bullet')
        elif elem.name == "br":
            doc.add_paragraph("")
        elif elem.string and elem.string.strip():
            doc.add_paragraph(elem.string.strip())

def export_internal_docx(df, proposal_text, file_obj):
    doc = Document()
    font = doc.styles['Normal'].font
    font.name = "Times New Roman"
    font.size = Pt(12)

    doc.add_heading("Internal Proposal", level=1)
    doc.add_paragraph("Generated analysis below is based on fund performance and benchmark comparison.\n")

    doc.add_heading("Recommendation", level=2)
    add_clean_html_paragraphs(doc, proposal_text)

    doc.add_paragraph("\nPerformance Table", style='Heading 2')
    if not df.empty:
        table = doc.add_table(rows=1, cols=len(df.columns))
        table.style = 'Table Grid'

        # Header
        hdr_cells = table.rows[0].cells
        for i, col in enumerate(df.columns):
            hdr_cells[i].text = str(col)
            hdr_cells[i].paragraphs[0].runs[0].bold = True
            hdr_cells[i].paragraphs[0].alignment = WD_PARAGRAPH_ALIGNMENT.CENTER

        # Rows
        for _, row in df.iterrows():
            cells = table.add_row().cells
            for i, val in enumerate(row):
                p = cells[i].paragraphs[0]
                run = p.add_run(str(val))
                p.alignment = WD_PARAGRAPH_ALIGNMENT.CENTER

    doc.add_paragraph("Generated by FidSync Beta")
    doc.save(file_obj)
